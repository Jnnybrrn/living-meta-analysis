<!doctype html>
<title>Username | Living Meta-Analysis</title>
<script src="/lib/promise.js"></script>
<script src="/lib/fetch.js"></script>
<script src="https://apis.google.com/js/platform.js"></script>
<link rel="stylesheet" href="/css/main.css">

<header>
  <a href="/" id="logo-box">
    <h1>LiMA</h1><h2>Living Meta-Analysis</h2>
  </a>
</header>

<h1>Please choose a username:</h1>
<div class="register">
  <p class="edithighlight">
    <span class='customusername' contenteditable placeholder="custom username"></span>
  </p>

  <form class='suggestions'>
  <h3>Suggestions:</h3>
    <span id='emailaddress'> same as email address</span>
    <span id='emailaddressfirst'> same as email address first part</span>
    <span id='displayname'> same as Google display name (without spaces)</span>
  <p>
    <button class="confirm">confirm</button>
  </p>
  <p class="output"></p>
</div>

<footer>
  <p>LiMA (Living Meta-Analysis) at <a href="http://port.ac.uk/">University of Portsmouth</a>, &copy; 2016â€“2017</p>
  <p>Feedback and questions are welcome at <a href="mailto:lima@port.ac.uk">lima@port.ac.uk</a>.</p>
</footer>


<script src="/js/tools.js"></script>
<script src="/js/auth.js"></script>
<script>
  'use strict';
  var lima = window.lima;
  var _ = lima._;  // underscore symbol is used for brevity, defined in tools.js

  /^[a-zA-Z0-9-_]+$/;
  var USERNAME_RE = /^[a-zA-Z][a-zA-Z0-9-_@\.]*$/;

  window.lima.initPage = function () {

    var email = lima.getAuthenticatedUserEmail();

    if (!email) {
      window.location.href = '/signin';
    }

    var currUser;

    lima.getGapiIDToken()
      .then(function (idToken) {
        return fetch('/api/profile/' + email, _.idTokenToFetchOptions(idToken));
      })
      .then(_.fetchJson)
      .then(function (user) {
        currUser = user;
      })
      .catch(function (err) {
        if (err.status === 404) {
          console.warn("Possibly this user isn't registered");
        }
      });

      if (!currUser) {
        // We don't have that user, so just use google's..
        currUser = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
      }
    fillRegisterPage(currUser);

    _.addEventListener('button.confirm', 'click', register);
  }

  function register() {
    // clear out old output
    _.fillEls('.output', '');

    // validate the user input
    var usernameEl = _.findEl('.customusername');
    var username = usernameEl.textContent.trim();

    if (!username.match(USERNAME_RE)) {
      _.fillEls('.output', 'invalid username');
      return;
    }

    // register the user with the server
    return lima.getGapiIDToken()
      .then(function(idToken) {
        var toSend = {'username':username};
        return fetch('/api/register', {
          method: 'POST',
          headers: _.idTokenToFetchHeaders(idToken, {'Content-type': 'application/json'}),
          body: JSON.stringify(toSend),
        });
      })
      .catch((err) => {
        // it didn't work, pass through to next catch error.
      })
      .then(function(res){
        // todo: remember where we yanked them from, send them back.
        window.location.href = '/profile';
      })
      .catch((err) => {
        console.error('failed to register user');
        console.error(err);
        _.fillEls('.output', 'failed to register');
      });
  }

  function fillRegisterPage(user) {
    // todo: Feels like there should be a way to get logged in user information
    // in a format we're used too, even if they don't exist saved yet.
    _.fillEls('.customusername', user.username || '');

    _.addEventListener('#emailaddress', 'click',  function(e){
      _.fillEls('.customusername', user.email || user.U3);
    });

    _.addEventListener('#emailaddressfirst', 'click',  function(e){
        var email = user.email || user.U3;
        var split = email.split('@');
      _.fillEls('.customusername', split[0]);
    });

    _.addEventListener('#displayname', 'click',  function(e){
        var displayName = user.displayName || user.ig;
        displayName = displayName.replace(/\s/g, '');
      _.fillEls('.customusername', displayName);
    });
  }

</script>
