<!doctype html>
<title>Username | Living Meta-Analysis</title>
<script src="/lib/promise.js"></script>
<script src="/lib/fetch.js"></script>
<script src="https://apis.google.com/js/platform.js"></script>
<link rel="stylesheet" href="/css/main.css">

<header>
  <a href="/" id="logo-box">
    <h1>LiMA</h1><h2>Living Meta-Analysis</h2>
  </a>
</header>

<div class="register">
  <h3>Please choose a username:</h3>
  <form class='suggestions'>
    <label>
      <!-- todo: This text box doesnt focus -->
      <span class='customusername' contenteditable placeholder="custom username"></span>
      <input type="radio" id="customusername" name="suggestion">
    </label>
    <label>
      <span class="emailaddress">error</span>
      <input type="radio" id="emailaddress" name="suggestion">
    </label>
    <label>
      <span class="emailaddressfirst">error</span>
      <input type="radio" id="emailaddressfirst" name="suggestion">
    </label>
    <label>
      <span class="displayname">error</span>
      <input type="radio" id="displayname" name="suggestion">
    </label>
    <div class="firsttimeonly hidden">
      <h3>You must accept the following:</h3>
      <label>
        I accept terms and conditions (ADD LINK HERE)
        <input type="checkbox" class="required" id="teesandcees">
      </label>
      <label>
        I accept privacy statement (ADD LINK HERE)
        <input type="checkbox" class="required" id="privacystatement">
      </label>
    </div>
    <p>
      <button class="register">register</button>
    </p>
  </form>
</div>

<footer>
  <p>LiMA (Living Meta-Analysis) at <a href="http://port.ac.uk/">University of Portsmouth</a>, &copy; 2016â€“2017</p>
  <p>Feedback and questions are welcome at <a href="mailto:lima@port.ac.uk">lima@port.ac.uk</a>.</p>
</footer>


<script src="/js/tools.js"></script>
<script src="/js/auth.js"></script>
<script>
  'use strict';
  var lima = window.lima;
  var _ = lima._;  // underscore symbol is used for brevity, defined in tools.js

  var USERNAME_RE = /^[a-zA-Z][a-zA-Z0-9_\.-]*$/;

  window.lima.initPage = function () {

    var email = lima.getAuthenticatedUserEmail();

    if (!email) {
      window.location.href = '/signin';
    }

    var currUser;
    var firstTimeUser = true;

    lima.getGapiIDToken()
    .then(function (idToken) {
      return fetch('/api/known/' + email, {
        method: 'GET',
        headers: _.idTokenToFetchHeaders(idToken),
      });
    })
    .then(function (res) {
      if (res.status !== 403) {
        lima.getGapiIDToken()
          .then(function (idToken) {
            return fetch('/api/profile/' + email, _.idTokenToFetchOptions(idToken));
          })
          .then(_.fetchJson)
          .then(function (user) {
            currUser = user;
            firstTimeUser = false;
          })
          .catch(function (err) {
            if (err.status === 404) {
              console.warn("Possibly this user isn't registered");
            }
          })
          .then(function() {
            fillRegisterPage(currUser, firstTimeUser);
          });
      } else {
        return Promise.reject();
      }
    })
    .catch(function(err) {
      if (!currUser) {
        // We don't have that user, so just use google's..
        currUser = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
      }
      fillRegisterPage(currUser, firstTimeUser);
    })

    _.addEventListener('button.register', 'click', register);
  }

  function register() {
    // validate the user input
    var checked = _.findEls('input[name="suggestion"]:checked')[0];
    var username;

    if (!checked) return; // todo: wont need when button only shows when selected..
    if (checked.id == 'customusername') {
      var customSpan = _.findPrecedingEl(checked, 'span.customusername');
      username = customSpan.textContent;
    } else {
      username = checked.value;
    }
    username = username.trim();


    if (!username.match(USERNAME_RE)) {
      // todo: show validation error here
      return;
    }

    // register the user with the server
    return lima.getGapiIDToken()
      .then(function(idToken) {
        var toSend = {'username':username};
        return fetch('/api/register', {
          method: 'POST',
          headers: _.idTokenToFetchHeaders(idToken, {'Content-type': 'application/json'}),
          body: JSON.stringify(toSend),
        });
      })
      .catch((err) => {
        // it didn't work, pass through to next catch error.
      })
      .then(function(res){
        // todo: remember where we yanked them from, send them back.
        window.location.href = '/profile';
      })
      .catch((err) => {
        console.error('failed to register user');
        console.error(err);
        // todo: show validation error here
      });
  }

  function fillRegisterPage(user, firstTimeUser) {
    var email = user.email || user.getEmail();
    var emailFirst = email.split('@')[0];
    var displayName = user.displayName || user.getName();
    displayName = displayName.replace(/\s/g, '');

    _.fillEls('form.suggestions span.emailaddress', email);
    _.setProps('form.suggestions input#emailaddress', 'value', email);

    _.fillEls('form.suggestions span.emailaddressfirst', emailFirst);
    _.setProps('form.suggestions input#emailaddressfirst', 'value', emailFirst);

    _.fillEls('form.suggestions span.displayname', displayName);
    _.setProps('form.suggestions input#displayname', 'value', displayName);

    if (firstTimeUser) {
      var firstTimeEl = _.findEl('.firsttimeonly');
      firstTimeEl.classList.remove('hidden');
      var registerButton = _.findEl('button.register');
      // todo: Is disabled strong enough? What do we want to happen if the user
      // works around this? Presume it's our usual stance, ie. Their problem when things break
      _.setProps('button.register', 'disabled', true);

      var checkboxes = _.findEls(firstTimeEl, '.required');
      checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('click', function(e){
          var firstTimeEl = _.findEl('.firsttimeonly');
          var checkboxes = _.findEls(firstTimeEl, '.required');
          var registerButton = _.findEl('button.register');
          var noChecked = 0;
          checkboxes.forEach(function(checkbox){
            if (checkbox.checked) {
              noChecked += 1;
            }
          });

          if (noChecked == checkboxes.length) {
            _.setProps('button.register', 'disabled', false);
          } else {
            _.setProps('button.register', 'disabled', true);
          }
        });
      });
    }
  }

</script>
